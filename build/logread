#!/usr/bin/python
from sys import argv
from hmac import HMAC
from hashlib import md5
from collections import defaultdict
from Crypto.Cipher.AES import AESCipher, MODE_CFB

assert argv[1] == '-K'
token = argv[2]
key = md5(token).digest()
log = argv[-1]
assert log.isalnum()
f = open(log)
mac = f.readline().strip()
assert HMAC(token, f.read()).hexdigest() == mac

on_site = {'-E':[], '-G':[]}
rooms = defaultdict(list)
folks = defaultdict(list)

f = open(log)
f.next()
for line in f:
	timestamp, al, eg, room_id, name = line.split()
	iv = md5(log+'-'+timestamp).digest()
	cipher = AESCipher(key, MODE_CFB, iv)
	al, eg, room_id, name = [cipher.decrypt(x.decode('hex')) for x in al, eg, room_id, name]
	room = room_id=='-'
	group = on_site[eg]
	if al == '-A':
		if room: group += [name]
		else:
			rooms[room_id] += [name]
			folks[name] += [room_id]
	else:
		if room: group.remove(name)
		else: rooms[room_id].remove(name)

def csv(L): return ','.join(sorted(L))

assert argv[3] in ('-S','-R')
if argv[3] == '-S':
	print csv(on_site['-E'])
	print csv(on_site['-G'])
	for room_id in sorted(rooms, key=int):
		if len(rooms[room_id]) > 0:
			print room_id+':', csv(rooms[room_id])
else:
	assert argv[4] in ('-E','-G')
	name = argv[5]
	print ','.join(folks[name])
