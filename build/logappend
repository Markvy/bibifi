#!/usr/bin/python
from sys import argv
from hmac import HMAC
def append():
	room = None
	i = 0
	while i < len(argv) - 2:
		i += 1
		cur, nxt = argv[i:i+2]
		if cur == '-K':
 			token = nxt
			i += 1
		elif cur == '-T':
			timestamp = nxt
			i += 1
		elif cur in ('-E','-G'):
			eg = cur
			name = nxt
			i += 1
		elif cur == '-R':
			room = nxt
			i += 1
    		else:
			assert argv[i] in ('-A','-L')
			al = argv[i]
	log = argv[-1]
	assert log.isalnum()
	try: f = open(log)
	except IOError:
		print >> open(log, 'w'), HMAC(token, '').hexdigest()
		f = open(log)
	mac = f.readline().strip()
	assert HMAC(token, f.read()).hexdigest() == mac
	print >> open(log, 'a'), timestamp, al, eg, name, room
	f = open(log)
	f.readline()
	print >> open(log, 'r+'), HMAC(token, f.read()).hexdigest()

if argv[1] != '-B': append()
else:
	for line in open(argv[2]):
		argv[1:] = line.split()
		append()
